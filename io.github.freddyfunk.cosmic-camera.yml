app-id: io.github.freddyfunk.cosmic-camera
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
base: com.system76.Cosmic.BaseApp
base-version: stable
command: camera

finish-args:
  # Wayland access
  - --socket=wayland
  # X11 Fallback
  - --share=ipc
  - --socket=fallback-x11
  # Webcam access (currently no better option than this)
  # https://docs.flatpak.org/en/latest/sandbox-permissions.html#device-access
  # Automatically includes GPU support since "dri" is part of "all"
  - --device=all
  # Home directory access for saving photos/videos
  - --filesystem=xdg-pictures:rw
  - --filesystem=xdg-videos:rw
  # PipeWire access for camera and audio
  - --filesystem=xdg-run/pipewire-0:ro
  # D-Bus access for COSMIC config daemon (live theme/config updates)
  - --talk-name=com.system76.CosmicSettingsDaemon
  # D-Bus access for "Show in Files" functionality
  - --talk-name=org.freedesktop.FileManager1
  # D-Bus access for WiFi connection from QR codes (system bus, not session bus)
  - --system-talk-name=org.freedesktop.NetworkManager

modules:
  - name: camera
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/camera/cargo
        CARGO_TARGET_DIR: /run/build/camera/target
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release --verbose
      # Install the binary
      - install -Dm755 target/release/camera /app/bin/camera
      # Install desktop file (rename to match app-id and update internal references)
      - sed 's/io.github.cosmicutils.camera/io.github.freddyfunk.cosmic-camera/g'
        resources/io.github.cosmicutils.camera.desktop >
        /tmp/io.github.freddyfunk.cosmic-camera.desktop
      - install -Dm644 /tmp/io.github.freddyfunk.cosmic-camera.desktop
        /app/share/applications/io.github.freddyfunk.cosmic-camera.desktop
      # Install icon (rename to match app-id)
      - install -Dm644 resources/icons/hicolor/scalable/apps/io.github.cosmicutils.camera.svg
        /app/share/icons/hicolor/scalable/apps/io.github.freddyfunk.cosmic-camera.svg
      # Install metainfo (rename to match app-id and update internal ID)
      - sed 's/io.github.cosmicutils.camera/io.github.freddyfunk.cosmic-camera/g'
        resources/io.github.cosmicutils.camera.metainfo.xml >
        /tmp/io.github.freddyfunk.cosmic-camera.metainfo.xml
      - install -Dm644 /tmp/io.github.freddyfunk.cosmic-camera.metainfo.xml
        /app/share/metainfo/io.github.freddyfunk.cosmic-camera.metainfo.xml
    sources:
      - type: git
        url: https://github.com/cosmic-utils/camera.git
        tag: v0.1.14
        commit: 31fcc73be7848909f6a7258679c973a4e377fc2a
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
          is-main-source: true
      - cargo-sources.json

  # Note: No additional GStreamer plugins needed - app uses pipewiresrc which is
  # included in org.freedesktop.Platform via PipeWire's gst-plugin-pipewire
